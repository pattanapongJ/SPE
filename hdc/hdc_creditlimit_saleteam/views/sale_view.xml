<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <record id="sot_sale_order_type_form_inherit" model="ir.ui.view">
        <field name="name">sale.order.type.form.view.inherit</field>
        <field name="model">sale.order.type</field>
        <field name="inherit_id" ref="sale_order_type.sot_sale_order_type_form_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='sequence_id']" position="after">
              <field name="is_credit_limit"/>
              <field name="pass_credit_limit" />
              <field name="below_cost" />
            </xpath>
        </field>
    </record>

    <record id="sale_order_view_tree_inherit_credit" model="ir.ui.view" >
        <field name="name">sale.order.inherit.credit.tree</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree" />
        <field name="arch" type="xml">
            <field name="company_id" position="after">
                <field name="temp_credit_ids" widget="many2many_tags"/>
            </field>
        </field>
    </record>

    <record id="view_sale_form_inherit_credit" model="ir.ui.view">
        <field name="name">view.sale.form.inherit.credit</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_confirm']" position="after">
                 <button name="create_credit_request" attrs="{'invisible': ['|',('temp_credit_create', '>', 0),('state', '!=', 'credit_limit')]}" string="Temp Credit Request" class="btn-primary" type="object"/>
            </xpath>

            <xpath expr="//button[@name='action_view_invoice']" position="after">
                <button name="action_temp_credit" type="object" class="oe_stat_button" icon="fa-file-text-o"
                        attrs="{'invisible': [('temp_credit_count', '=', 0)]}">
                    <field name="temp_credit_count" widget="statinfo" string="Temp Credit Request"/>
                    <field name="temp_credit_create" invisible="1"/>
                </button>
            </xpath>

            <xpath expr="//notebook/page[@name='order_lines']/field[@name='order_line']/tree" position="replace">
                <tree
                    string="Sales Order Lines"
                    editable="bottom"
                >
                    <control>
                        <create name="add_product_control" string="Add a product"/>
                        <create name="add_section_control" string="Add a section" context="{'default_display_type': 'line_section'}"/>
                        <create name="add_note_control" string="Add a note" context="{'default_display_type': 'line_note'}"/>
                    </control>

                    <field name="sequence" widget="handle" />
                    <!-- We do not display the type because we don't want the user to be bothered with that information if he has no section or note. -->
                    <field name="display_type" invisible="1"/>
                    <field name="product_uom_category_id" invisible="1"/>

                    <field name="product_updatable" invisible="1"/>
                    <field
                        name="product_id"
                        attrs="{
                            'readonly': ['|','|',('product_updatable', '=', False),('state', 'in', ('done','sale','cancel')),('blanket_order_line', '!=',False)],
                            'required': [('display_type', '=', False)],
                        }"
                        options="{'no_open': True}"
                        force_save="1"
                        context="{
                            'partner_id': parent.partner_id,
                            'quantity': product_uom_qty,
                            'pricelist': parent.pricelist_id,
                            'uom':product_uom,
                            'company_id': parent.company_id,
                            'default_lst_price': price_unit,
                            'default_description_sale': name
                        }"
                        domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                        widget="product_configurator"
                    />
                    <field name="product_template_id"
                      string="Product"
                      invisible="1"
                      attrs="{
                          'readonly': [('product_updatable', '=', False)],
                          'required': [('display_type', '=', False)],
                      }"
                      options="{'no_open': True}"
                      context="{
                          'partner_id': parent.partner_id,
                          'quantity': product_uom_qty,
                          'pricelist': parent.pricelist_id,
                          'uom':product_uom,
                          'company_id': parent.company_id,
                          'default_list_price': price_unit,
                          'default_description_sale': name
                      }"
                      domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                      widget="product_configurator"/>
                    <field name="name" widget="section_and_note_text" optional="show" attrs="{'readonly': [('state', 'in', ('done','sale','cancel'))]}"/>
                    <field name="note" widget="section_and_note_text" optional="hide" />
                    <field
                        name="analytic_tag_ids"
                        optional="hide"
                        groups="analytic.group_analytic_tags"
                        widget="many2many_tags"
                        options="{'color_field': 'color'}"
                        domain="['|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                        attrs="{'readonly': [('state', 'in', ('done','sale','cancel'))]}"
                    />
                    <field
                        name="product_uom_qty"
                        decoration-info="(not display_type and invoice_status == 'to invoice')" decoration-bf="(not display_type and invoice_status == 'to invoice')"
                        context="{
                            'partner_id': parent.partner_id,
                            'quantity': product_uom_qty,
                            'pricelist': parent.pricelist_id,
                            'uom': product_uom,
                            'company_id': parent.company_id
                        }"
                        attrs="{'readonly': ['|',('blanket_order_line', '!=',False),('state', 'in', ('done','sale','cancel'))]}"
                    />
                    <field
                        name="qty_delivered"
                        decoration-info="(not display_type and invoice_status == 'to invoice')" decoration-bf="(not display_type and invoice_status == 'to invoice')"
                        string="Delivered"
                        attrs="{
                            'column_invisible': [('parent.state', 'not in', ['sale', 'done'])],'readonly': ['|',('qty_delivered_method', '!=', 'manual'),('state', 'in', ('done','sale','cancel'))]
                        }"
                        optional="show"
                    />
                    <field name="qty_delivered_manual" invisible="1"/>
                    <field name="qty_delivered_method" invisible="1"/>
                    <field
                        name="qty_invoiced"
                        decoration-info="(not display_type and invoice_status == 'to invoice')" decoration-bf="(not display_type and invoice_status == 'to invoice')"
                        string="Invoiced"
                        attrs="{'column_invisible': [('parent.state', 'not in', ['sale', 'done'])],
                        'readonly': [('state', 'in', ('done','sale','cancel'))]}"
                        optional="show"
                    />
                    <field name="qty_to_invoice" invisible="1"/>
                    <field name="product_uom_readonly" invisible="1"/>
                    <field
                        name="product_uom"
                        force_save="1"
                        string="UoM"
                        attrs="{
                            'readonly': ['|',('product_uom_readonly', '=', True),('state', 'in', ('done','sale','cancel'))],
                            'required': [('display_type', '=', False)],
                        }"
                        context="{'company_id': parent.company_id}"
                        groups="uom.group_uom"
                        options='{"no_open": True}'
                        optional="show"
                    />
                    <field
                        name="customer_lead"
                        optional="hide"
                        attrs="{'readonly': ['|',('parent.state', 'not in', ['draft', 'sent', 'sale']),('state', 'in', ('done','sale','cancel'))]}"
                    />
                    <field
                        name="price_unit"
                        attrs="{'readonly': ['|',('qty_invoiced', '&gt;', 0),('state', 'in', ('done','sale','cancel'))]}"
                    />
                    <field
                        name="tax_id"
                        widget="many2many_tags"
                        readonly="1" force_save="1"
                        options="{'no_create': True}"
                        domain="[('type_tax_use','=','sale'),('company_id','=',parent.company_id)]"
                        context="{'active_test': True}"
                        attrs="{'readonly': ['|',('qty_invoiced', '&gt;', 0),('state', 'in', ('done','sale','cancel'))]}"
                        optional="show"
                    />
                    <field name="discount" string="Disc.%" groups="product.group_discount_per_so_line" optional="show" widget="product_discount" attrs="{'readonly': [('state', 'in', ('done','sale','cancel'))]}"/>
                    <field name="price_subtotal" optional="hide" widget="monetary" groups="account.group_show_line_subtotals_tax_excluded" />
                    <field name="price_total" widget="monetary" groups="account.group_show_line_subtotals_tax_included"/>
                    <field name="state" invisible="1"/>
                    <field name="invoice_status" invisible="1"/>
                    <field name="currency_id" invisible="1"/>
                    <field name="price_tax" invisible="1"/>
                    <field name="company_id" invisible="1"/>
                </tree>
            </xpath>
        </field>
    </record>

    <record id="view_sale_order_confirm_inherit_form_creditlimit" model="ir.ui.view">
        <field name="name">sale.order.confirm.inherit.form</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="dev_customer_credit_limit.view_sale_order_confirm_inherit_form"/>
        <field name="arch" type="xml">

            <xpath expr="//button[@name='action_confirm']" position="replace">
                 <field name="check_credit_approve" invisible="1"/>
                 <button name="action_confirm" string="Confirm Sale"
                         attrs="{'invisible': ['|','|',('state', '!=', 'credit_limit'),
                         ('check_credit_approve', '=', False),('check_credit_limit_on_hold','=',True)]}"
                         class="btn-primary" type="object" context="{'show_sale': True}"
                         groups="sales_team.group_sale_manager"/>
            </xpath>
        </field>
    </record>
    <record id="sot_view_order_form_inherit_form_credit_limit" model="ir.ui.view">
        <field name="name">sale.order.confirm.inherit.form</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale_order_type.sot_view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='type_id']" position="after">
                <field name="is_credit_limit" readonly="1" force_save="1" />
            </xpath>
        </field>
    </record>
    <record id="view_order_form_inherit_discount_inherit_form_creditlimit" model="ir.ui.view">
        <field name="name">view.order.form.inherit.discount.inherit.form.creditlimit</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="hdc_sale_line_detail.view_order_form_inherit_discount"/>
        <field name="arch" type="xml">
            <xpath expr="//notebook/page[@name='line_detail']" position="after">
                <page string="Remark On hold" name="remark_on_hold_detail">
                    <group string="Remark On Hold" name="remark_on_hold_report_group">
                        <div>
                            <field name="remark_onhold" class="oe_inline"/>
                        </div>
                    </group>
                </page>
            </xpath>
        </field>
    </record>
</odoo>
